// ==========================================
// ‚ùÑÔ∏è GECE SOƒûUƒûU VE DON Rƒ∞SKƒ∞ Y√ñNETƒ∞M Sƒ∞STEMƒ∞
// ==========================================

import { HourlyWeatherRecord } from './types';

export interface FrostRiskAnalysis {
  frostRiskLevel: 'NONE' | 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';
  minTemperature: number;
  frostStartHour?: number;
  frostEndHour?: number;
  riskFactors: {
    isCriticalTemperature: boolean;
    isNighttime: boolean;
    hasHighHumidity: boolean;
    hasLowWind: boolean;
    soilTemperature: number;
  };
  irrigationWarning: {
    shouldAvoidIrrigation: boolean;
    safestHours: number[];
    dangerousHours: number[];
    recommendations: string[];
  };
  protectionMeasures: string[];
  cropDamageRisk: {
    level: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';
    vulnerableCrops: string[];
    estimatedDamage: number; // Percentage
  };
}

export interface IrrigationFrostCheck {
  isSafeToIrrigate: boolean;
  currentTemperature: number;
  nextHourTemperature: number;
  soilTemperature: number;
  riskLevel: 'SAFE' | 'CAUTION' | 'AVOID' | 'DANGEROUS';
  timeUntilSafe?: number; // Hours
  recommendations: string[];
  alternativeMethods: string[];
}

export class FrostProtectionService {
  // Kritik sƒ±caklƒ±k e≈üikleri (¬∞C)
  private readonly TEMPERATURE_THRESHOLDS = {
    FROST_WARNING: 5,      // Don uyarƒ±sƒ±
    LIGHT_FROST: 2,        // Hafif don
    MODERATE_FROST: 0,     // Orta don
    SEVERE_FROST: -2,      // ≈ûiddetli don
    CRITICAL_FROST: -5     // Kritik don
  };

  // √úr√ºn hassasiyet seviyeleri
  private readonly CROP_SENSITIVITY = {
    'TOMATO': { threshold: 4, vulnerability: 'HIGH' },
    'PEPPER': { threshold: 4, vulnerability: 'HIGH' },
    'CORN': { threshold: 2, vulnerability: 'MEDIUM' },
    'WHEAT': { threshold: -2, vulnerability: 'LOW' },
    'BARLEY': { threshold: -3, vulnerability: 'LOW' },
    'OATS': { threshold: -2, vulnerability: 'LOW' },
    'BEAN': { threshold: 3, vulnerability: 'HIGH' },
    'CHICKPEA': { threshold: 1, vulnerability: 'MEDIUM' },
    'SUNFLOWER': { threshold: 1, vulnerability: 'MEDIUM' },
    'COTTON': { threshold: 5, vulnerability: 'HIGH' }
  };

  /**
   * Gece soƒüuƒüu ve don riskini analiz eder
   */
  analyzeFrostRisk(
    hourlyData: HourlyWeatherRecord[],
    currentTime = new Date()
  ): FrostRiskAnalysis {
    const currentHour = currentTime.getHours();

    // Gece saatleri (20:00 - 08:00) analizi
    const nightHours = this.getNightHoursData(hourlyData, currentHour);
    const minTemp = this.findMinimumTemperature(nightHours);
    const frostPeriod = this.calculateFrostPeriod(nightHours);

    // Risk fakt√∂rleri
    const riskFactors = this.calculateRiskFactors(nightHours[0] || {}, minTemp);

    // Risk seviyesi belirleme
    const frostRiskLevel = this.determineFrostRiskLevel(minTemp, riskFactors);

    // Sulama uyarƒ±sƒ±
    const irrigationWarning = this.generateIrrigationWarning(
      nightHours,
      frostRiskLevel,
      currentHour
    );

    // Koruma √∂nlemleri
    const protectionMeasures = this.generateProtectionMeasures(frostRiskLevel, minTemp);

    // √úr√ºn hasarƒ± riski
    const cropDamageRisk = this.assessCropDamageRisk(minTemp, frostRiskLevel);

    return {
      frostRiskLevel,
      minTemperature: minTemp,
      frostStartHour: frostPeriod.startHour,
      frostEndHour: frostPeriod.endHour,
      riskFactors,
      irrigationWarning,
      protectionMeasures,
      cropDamageRisk
    };
  }

  /**
   * Sulama √∂ncesi don kontrol√º
   */
  checkIrrigationFrostRisk(
    hourlyData: HourlyWeatherRecord[],
    plannedHour?: number
  ): IrrigationFrostCheck {
    const currentHour = plannedHour || new Date().getHours();
    const currentData = hourlyData[0] || {};
    const nextHourData = hourlyData[1] || {};

    const currentTemp = currentData.temperature2m || 0;
    const nextTemp = nextHourData.temperature2m || 0;
    const soilTemp = currentData.soilTemperature0cm || currentTemp;

    // Risk seviyesi belirleme
    let riskLevel: IrrigationFrostCheck['riskLevel'] = 'SAFE';

    if (currentTemp <= this.TEMPERATURE_THRESHOLDS.SEVERE_FROST) {
      riskLevel = 'DANGEROUS';
    } else if (currentTemp <= this.TEMPERATURE_THRESHOLDS.MODERATE_FROST) {
      riskLevel = 'AVOID';
    } else if (currentTemp <= this.TEMPERATURE_THRESHOLDS.LIGHT_FROST) {
      riskLevel = 'CAUTION';
    } else if (currentTemp <= this.TEMPERATURE_THRESHOLDS.FROST_WARNING) {
      riskLevel = 'CAUTION';
    }

    // Gece saatlerinde ek risk
    if (this.isNighttime(currentHour) && currentTemp < 10) {
      if (riskLevel === 'SAFE') riskLevel = 'CAUTION';
    }

    const isSafeToIrrigate = riskLevel === 'SAFE' || riskLevel === 'CAUTION';

    // G√ºvenli zaman hesaplama
    const timeUntilSafe = this.calculateTimeUntilSafe(hourlyData, currentHour);

    // √ñneriler
    const recommendations = this.generateFrostIrrigationRecommendations(
      riskLevel,
      currentTemp,
      nextTemp,
      soilTemp
    );

    // Alternatif y√∂ntemler
    const alternativeMethods = this.generateAlternativeMethods(riskLevel, currentTemp);

    return {
      isSafeToIrrigate,
      currentTemperature: currentTemp,
      nextHourTemperature: nextTemp,
      soilTemperature: soilTemp,
      riskLevel,
      timeUntilSafe,
      recommendations,
      alternativeMethods
    };
  }

  /**
   * Gece saatlerinin verilerini alƒ±r
   */
  private getNightHoursData(
    hourlyData: HourlyWeatherRecord[],
    currentHour: number
  ): HourlyWeatherRecord[] {
    const nightData: HourlyWeatherRecord[] = [];

    // Ak≈üam 20:00'dan sabah 08:00'a kadar
    for (let i = 0; i < 24 && i < hourlyData.length; i++) {
      const hour = (currentHour + i) % 24;
      if (this.isNighttime(hour)) {
        nightData.push(hourlyData[i]);
      }
    }

    return nightData;
  }

  /**
   * Gece saati kontrol√º (20:00-08:00)
   */
  private isNighttime(hour: number): boolean {
    return hour >= 20 || hour <= 8;
  }

  /**
   * Minimum sƒ±caklƒ±ƒüƒ± bulur
   */
  private findMinimumTemperature(nightData: HourlyWeatherRecord[]): number {
    if (nightData.length === 0) return 0;

    return Math.min(...nightData.map(data => data.temperature2m || 0));
  }

  /**
   * Don periyodunu hesaplar
   */
  private calculateFrostPeriod(nightData: HourlyWeatherRecord[]): {
    startHour?: number;
    endHour?: number;
  } {
    let startHour: number | undefined;
    let endHour: number | undefined;

    for (let i = 0; i < nightData.length; i++) {
      const temp = nightData[i].temperature2m || 0;

      if (temp <= this.TEMPERATURE_THRESHOLDS.LIGHT_FROST) {
        if (startHour === undefined) {
          startHour = i;
        }
        endHour = i;
      }
    }

    return { startHour, endHour };
  }

  /**
   * Risk fakt√∂rlerini hesaplar
   */
  private calculateRiskFactors(
    currentData: HourlyWeatherRecord,
    minTemp: number
  ): FrostRiskAnalysis['riskFactors'] {
    const currentHour = new Date().getHours();

    return {
      isCriticalTemperature: minTemp <= this.TEMPERATURE_THRESHOLDS.MODERATE_FROST,
      isNighttime: this.isNighttime(currentHour),
      hasHighHumidity: (currentData.relativeHumidity2m || 0) > 80,
      hasLowWind: (currentData.windSpeed10m || 0) < 5,
      soilTemperature: currentData.soilTemperature0cm || minTemp
    };
  }

  /**
   * Don risk seviyesini belirler
   */
  private determineFrostRiskLevel(
    minTemp: number,
    riskFactors: FrostRiskAnalysis['riskFactors']
  ): FrostRiskAnalysis['frostRiskLevel'] {
    if (minTemp <= this.TEMPERATURE_THRESHOLDS.CRITICAL_FROST) {
      return 'CRITICAL';
    } else if (minTemp <= this.TEMPERATURE_THRESHOLDS.SEVERE_FROST) {
      return 'HIGH';
    } else if (minTemp <= this.TEMPERATURE_THRESHOLDS.MODERATE_FROST) {
      return 'MEDIUM';
    } else if (minTemp <= this.TEMPERATURE_THRESHOLDS.LIGHT_FROST) {
      return 'LOW';
    } else {
      return 'NONE';
    }
  }

  /**
   * Sulama uyarƒ±sƒ± olu≈üturur
   */
  private generateIrrigationWarning(
    nightData: HourlyWeatherRecord[],
    riskLevel: FrostRiskAnalysis['frostRiskLevel'],
    currentHour: number
  ): FrostRiskAnalysis['irrigationWarning'] {
    const shouldAvoidIrrigation = riskLevel === 'MEDIUM' || riskLevel === 'HIGH' || riskLevel === 'CRITICAL';

    // G√ºvenli saatler (sƒ±caklƒ±k > 5¬∞C)
    const safestHours: number[] = [];
    const dangerousHours: number[] = [];

    for (let i = 0; i < 24; i++) {
      const hour = (currentHour + i) % 24;
      const temp = nightData[i]?.temperature2m || 0;

      if (temp > this.TEMPERATURE_THRESHOLDS.FROST_WARNING) {
        safestHours.push(hour);
      } else if (temp <= this.TEMPERATURE_THRESHOLDS.LIGHT_FROST) {
        dangerousHours.push(hour);
      }
    }

    const recommendations = this.generateIrrigationWarningRecommendations(
      riskLevel,
      shouldAvoidIrrigation
    );

    return {
      shouldAvoidIrrigation,
      safestHours: safestHours.slice(0, 6),
      dangerousHours,
      recommendations
    };
  }

  /**
   * Sulama uyarƒ± √∂nerilerini olu≈üturur
   */
  private generateIrrigationWarningRecommendations(
    riskLevel: FrostRiskAnalysis['frostRiskLevel'],
    shouldAvoid: boolean
  ): string[] {
    const recommendations: string[] = [];

    switch (riskLevel) {
      case 'CRITICAL':
        recommendations.push(
          'üö® KRƒ∞Tƒ∞K DON Rƒ∞SKƒ∞!',
          'T√úM SULAMA ƒ∞≈ûLEMLERƒ∞Nƒ∞ DURDURUN',
          'Bitkileri koruma altƒ±na alƒ±n',
          'Acil koruma √∂nlemleri uygulayƒ±n'
        );
        break;

      case 'HIGH':
        recommendations.push(
          '‚ùÑÔ∏è Y√ºksek don riski!',
          'Sulama yapmayƒ±n - bitkileri dondurir',
          'Sƒ±cak saatleri bekleyin (10:00-15:00)',
          'Damla sulama bile riskli'
        );
        break;

      case 'MEDIUM':
        recommendations.push(
          '‚ö†Ô∏è Orta seviye don riski',
          'Gece sulamasƒ±ndan ka√ßƒ±nƒ±n',
          'Sabah g√ºne≈ü √ßƒ±ktƒ±ktan sonra sulayƒ±n',
          'Toprak sƒ±caklƒ±ƒüƒ±nƒ± kontrol edin'
        );
        break;

      case 'LOW':
        recommendations.push(
          'üå°Ô∏è Hafif don riski',
          'Dikkatli sulama yapabilirsiniz',
          'G√ºnd√ºz saatlerini tercih edin',
          'Toprak nemini fazla artƒ±rmayƒ±n'
        );
        break;

      default:
        recommendations.push(
          '‚úÖ Don riski yok',
          'Normal sulama programƒ±nƒ±zƒ± s√ºrd√ºr√ºn'
        );
    }

    return recommendations;
  }

  /**
   * Koruma √∂nlemlerini olu≈üturur
   */
  private generateProtectionMeasures(
    riskLevel: FrostRiskAnalysis['frostRiskLevel'],
    minTemp: number
  ): string[] {
    const measures: string[] = [];

    switch (riskLevel) {
      case 'CRITICAL':
        measures.push(
          'Acil ƒ±sƒ±tma sistemleri kurun',
          'Antifreeze kimyasallarƒ± uygulayƒ±n',
          '√ñrt√º sistemleri devreye alƒ±n',
          'R√ºzgar makineleri √ßalƒ±≈ütƒ±rƒ±n',
          'Acil koruma bariyerleri kurun'
        );
        break;

      case 'HIGH':
        measures.push(
          'Koruyucu √∂rt√ºler serin',
          'Isƒ±tma sistemlerini hazƒ±rlayƒ±n',
          'R√ºzgar koruma bariyerleri kurun',
          'Su p√ºsk√ºrtme sistemini hazƒ±rlayƒ±n',
          'Hassas bitkileri koruma altƒ±na alƒ±n'
        );
        break;

      case 'MEDIUM':
        measures.push(
          'Hafif √∂rt√º √∂rt√ºn',
          'Mul√ßlama yapƒ±n',
          'Su toplama alanlarƒ±nƒ± bo≈üaltƒ±n',
          'R√ºzgar kesiciler yerle≈ütirin'
        );
        break;

      case 'LOW':
        measures.push(
          'ƒ∞zleme sistemlerini aktif tutun',
          'Koruma malzemelerini hazƒ±r bulundurun',
          'Hava durumunu takip edin'
        );
        break;

      default:
        measures.push('Normal koruma √∂nlemleri yeterli');
    }

    measures.push(`Minimum sƒ±caklƒ±k: ${minTemp}¬∞C`);

    return measures;
  }

  /**
   * √úr√ºn hasarƒ± riskini deƒüerlendirir
   */
  private assessCropDamageRisk(
    minTemp: number,
    riskLevel: FrostRiskAnalysis['frostRiskLevel']
  ): FrostRiskAnalysis['cropDamageRisk'] {
    const vulnerableCrops: string[] = [];
    let estimatedDamage = 0;
    let level: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL' = 'LOW';

    // √úr√ºn hassasiyetlerini kontrol et
    for (const [crop, sensitivity] of Object.entries(this.CROP_SENSITIVITY)) {
      if (minTemp <= sensitivity.threshold) {
        vulnerableCrops.push(crop);

        // Hasar oranƒ±nƒ± hesapla
        const tempDiff = sensitivity.threshold - minTemp;
        let cropDamage = 0;

        if (sensitivity.vulnerability === 'HIGH') {
          cropDamage = Math.min(tempDiff * 20, 95);
        } else if (sensitivity.vulnerability === 'MEDIUM') {
          cropDamage = Math.min(tempDiff * 15, 70);
        } else {
          cropDamage = Math.min(tempDiff * 10, 50);
        }

        estimatedDamage = Math.max(estimatedDamage, cropDamage);
      }
    }

    // Risk seviyesi belirleme
    if (estimatedDamage > 80) {
      level = 'CRITICAL';
    } else if (estimatedDamage > 50) {
      level = 'HIGH';
    } else if (estimatedDamage > 20) {
      level = 'MEDIUM';
    }

    return {
      level,
      vulnerableCrops,
      estimatedDamage: Math.round(estimatedDamage)
    };
  }

  /**
   * G√ºvenli zamana kadar olan s√ºreyi hesaplar
   */
  private calculateTimeUntilSafe(
    hourlyData: HourlyWeatherRecord[],
    currentHour: number
  ): number | undefined {
    for (let i = 1; i < Math.min(hourlyData.length, 24); i++) {
      const temp = hourlyData[i].temperature2m || 0;
      const hour = (currentHour + i) % 24;

      // G√ºvenli sƒ±caklƒ±k ve g√ºnd√ºz saati
      if (temp > this.TEMPERATURE_THRESHOLDS.FROST_WARNING && !this.isNighttime(hour)) {
        return i;
      }
    }

    return undefined;
  }

  /**
   * Don riski sulama √∂nerilerini olu≈üturur
   */
  private generateFrostIrrigationRecommendations(
    riskLevel: IrrigationFrostCheck['riskLevel'],
    currentTemp: number,
    nextTemp: number,
    soilTemp: number
  ): string[] {
    const recommendations: string[] = [];

    switch (riskLevel) {
      case 'DANGEROUS':
        recommendations.push(
          'üö® SULAMA YASAK!',
          'Su bitkiyi donduracak',
          'Sƒ±caklƒ±k y√ºkselene kadar bekleyin',
          'Acil koruma √∂nlemleri alƒ±n'
        );
        break;

      case 'AVOID':
        recommendations.push(
          '‚ùÑÔ∏è Sulama √∂nerilmez',
          'Don riski √ßok y√ºksek',
          'G√ºnd√ºz saatlerini bekleyin',
          'Toprak sƒ±caklƒ±ƒüƒ±nƒ± √∂l√ß√ºn'
        );
        break;

      case 'CAUTION':
        recommendations.push(
          '‚ö†Ô∏è Dikkatli olun',
          '√áok az miktarda sulayƒ±n',
          'Toprak sƒ±caklƒ±ƒüƒ±nƒ± kontrol edin',
          'Hava ƒ±sƒ±nana kadar beklemek daha iyi'
        );
        break;

      default:
        recommendations.push(
          '‚úÖ Sulama g√ºvenli',
          'Normal sulama yapabilirsiniz'
        );
    }

    recommendations.push(
      `Mevcut: ${currentTemp}¬∞C, Sonraki saat: ${nextTemp}¬∞C`,
      `Toprak sƒ±caklƒ±ƒüƒ±: ${soilTemp}¬∞C`
    );

    return recommendations;
  }

  /**
   * Alternatif y√∂ntemler √∂nerir
   */
  private generateAlternativeMethods(
    riskLevel: IrrigationFrostCheck['riskLevel'],
    currentTemp: number
  ): string[] {
    const methods: string[] = [];

    if (riskLevel === 'DANGEROUS' || riskLevel === 'AVOID') {
      methods.push(
        'G√ºnd√ºz saatlerinde (10:00-15:00) sulama',
        'Sera i√ßi sƒ±cak su uygulamasƒ±',
        'Isƒ±tmalƒ± sulama sistemi',
        'ƒ∞lkbahar ba≈üƒ±nda erken sulama'
      );
    } else if (riskLevel === 'CAUTION') {
      methods.push(
        'D√º≈ü√ºk basƒ±n√ßlƒ± damla sulama',
        'Toprak ƒ±sƒ±tmasƒ± ile birlikte sulama',
        'G√ºnd√ºz √∂ncesi hafif nemlendireme'
      );
    } else {
      methods.push(
        'Normal sulama y√∂ntemleri',
        'Fƒ±skiye sulama uygun',
        'Damla sulama optimal'
      );
    }

    return methods;
  }
}

export const frostProtectionService = new FrostProtectionService();